name: Deploy Backend

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew clean bootJar

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Create application configs
        run: |
          mkdir -p config

          cat > config/application.yml << 'EOF'
          spring:
            application:
              name: test
            profiles:
              include:
                - private

            servlet:
              multipart:
                max-file-size: 500MB
                max-request-size: 500MB

            datasource:
              hikari:
                maximum-pool-size: 10
                minimum-idle: 2
                connection-timeout: 20000
                idle-timeout: 600000
                max-lifetime: 1800000
                leak-detection-threshold: 60000

          mybatis:
            configuration:
              map-underscore-to-camel-case: true
              jdbc-type-for-null: VARCHAR
              log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
            type-aliases-package: com.kh.replay.**.model.vo, com.kh.replay.**.model.dto
            mapper-locations: classpath:mapper/**/*.xml

          server:
            port: 8080

          api:
            itunes:
              url: https://itunes.apple.com/search
            deezer:
              url: https://api.deezer.com
            lyrics:
              url: https://api.lyrics.ovh/v1/
          EOF

          cat > config/application-private.yml << EOF
          spring:
            application:
              name: replay

            datasource:
              url: ${{ secrets.DB_URL }}
              username: ${{ secrets.DB_USERNAME }}
              password: ${{ secrets.DB_PASSWORD }}
              driver-class-name: oracle.jdbc.driver.OracleDriver

            security:
              oauth2:
                client:
                  registration:
                    google:
                      client-id: ${{ secrets.GOOGLE_CLIENT_ID }}
                      client-secret: ${{ secrets.GOOGLE_CLIENT_SECRET }}
                      redirect-uri: "http://${{ secrets.EC2_HOST }}:8080/login/oauth2/code/google"
                      scope:
                        - profile
                        - email
                  provider:
                    google:
                      authorization-uri: https://accounts.google.com/o/oauth2/v2/auth
                      token-uri: https://oauth2.googleapis.com/token
                      user-info-uri: https://www.googleapis.com/oauth2/v3/userinfo
                      user-name-attribute: sub

          instance:
            url: http://${{ secrets.EC2_HOST }}:8080

          front:
            base-url: http://${{ secrets.EC2_HOST }}

          jwt:
            secret: ${{ secrets.JWT_SECRET }}

          cloud:
            aws:
              credentials:
                access-key: '${{ secrets.AWS_ACCESS_KEY }}'
                secret-key: '${{ secrets.AWS_SECRET_KEY }}'
              region:
                static: ${{ secrets.AWS_REGION }}
              s3:
                bucket: ${{ secrets.AWS_S3_BUCKET }}

          naver:
            client:
              id: ${{ secrets.NAVER_CLIENT_ID }}
              secret: ${{ secrets.NAVER_CLIENT_SECRET }}
          EOF

      - name: Deploy to EC2
        run: |
          # Upload JAR file
          scp -i ~/.ssh/id_rsa build/libs/*.jar ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/app/back/replay.jar

          # Upload config files
          scp -i ~/.ssh/id_rsa config/application.yml ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/app/back/config/
          scp -i ~/.ssh/id_rsa config/application-private.yml ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/app/back/config/

          # Restart API container
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "sudo docker restart replay-api"

      - name: Verify deployment
        run: |
          sleep 30
          curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.EC2_HOST }}:8080/api/music/new | grep -q "200" && echo "Backend deployment successful!" || echo "Backend may still be starting up..."
