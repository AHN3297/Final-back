<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kh.replay.auth.admin.model.dao.AdminMapper">

	<!-- 회원 목록 조회 (searchMemberList 추가) -->
	<select id="searchMemberList"
		parameterType="com.kh.replay.auth.admin.model.dto.PageRequestDTO"
		resultType="com.kh.replay.member.model.dto.MemberDTO"> SELECT MEMBER_ID
		AS memberId, REGEXP_REPLACE(EMAIL, '(.{3})(.*)(@.*)', '\1***\3') AS
		email, REGEXP_REPLACE(MEMBER_NAME, '(.)(.+)', '\1' || RPAD('*',
		LENGTH('\2'), '*')) AS name, GENDER AS gender, MBTI AS mbti, UPDATED_AT
		AS updatedAt, REGEXP_REPLACE(PHONE, '([0-9]{3})([0-9]{4})([0-9]{4})',
		'\1-****-\3') AS phone, MEMBER_JOB AS job, NICKNAME AS nickName,
		CREATED_AT AS createdAt, ROLE AS role, STATUS AS status FROM TB_MEMBER
		WHERE MEMBER_ID IS NOT NULL AND STATUS = 'Y' <if test="keyword != null">
		AND (MEMBER_ID LIKE #{keyword}
			OR EMAIL LIKE #{keyword}
			OR MEMBER_NAME LIKE #{keyword})
		</if>
		ORDER BY CREATED_AT DESC OFFSET #{offset} ROWS FETCH NEXT #{limit} ROWS
		ONLY </select>

	<!-- 기존 getMemberList (사용 중이면 유지) -->
	<select id="getMemberList"
		resultType="com.kh.replay.member.model.dto.MemberDTO">
		SELECT
		MEMBER_ID AS memberId,
		REGEXP_REPLACE(EMAIL, '(.{3})(.*)(@.*)', '\1***\3') AS email,
		REGEXP_REPLACE(MEMBER_NAME, '(.)(.+)', '\1' || RPAD('*', LENGTH('\2'),
		'*')) AS name,
		GENDER AS gender,
		MBTI AS mbti,
		UPDATED_AT AS updatedAt,
		REGEXP_REPLACE(PHONE, '([0-9]{3})([0-9]{4})([0-9]{4})', '\1-****-\3') AS
		phone,
		MEMBER_JOB AS job,
		NICKNAME AS nickName,
		CREATED_AT AS createdAt,
		ROLE AS role,
		STATUS AS status
		FROM TB_MEMBER
		WHERE MEMBER_ID IS NOT NULL
		AND STATUS = 'Y'
		ORDER BY CREATED_AT DESC
		OFFSET #{offset} ROWS
		FETCH NEXT #{size} ROWS ONLY
	</select>

	<!-- 회원 정보 조회 (권한 변경 후) - 추가 -->
	<select id="getMemberInfo" parameterType="string"
		resultType="com.kh.replay.member.model.dto.MemberDTO">
		SELECT
		M.MEMBER_ID AS memberId,
		M.MEMBER_NAME AS name,
		M.MBTI AS mbti,
		M.MEMBER_JOB AS job,
		M.GENDER AS gender,
		M.ROLE AS role,
		M.STATUS AS status,
		M.NICKNAME AS nickName,
		M.PHONE AS phone,
		M.EMAIL AS email,
		M.UPDATED_AT AS updatedAt,
		M.CREATED_AT AS createdAt,
		LISTAGG(G.GENRE_NAME, ', ') WITHIN GROUP (ORDER BY G.GENRE_NAME) AS
		genre
		FROM TB_MEMBER M
		LEFT JOIN TB_MEMBER_GENRE MG ON M.MEMBER_ID = MG.MEMBER_ID
		LEFT JOIN TB_GENRE G ON MG.GENRE_ID = G.GENRE_ID
		WHERE M.MEMBER_ID = #{memberId}
		GROUP BY
		M.MEMBER_ID,
		M.MEMBER_NAME,
		M.MBTI,
		M.MEMBER_JOB,
		M.GENDER,
		M.ROLE,
		M.STATUS,
		M.NICKNAME,
		M.PHONE,
		M.EMAIL,
		M.UPDATED_AT,
		M.CREATED_AT
	</select>

	<!-- 회원 상세 조회 -->
	<select id="getMemberDetails" resultMap="memberDetailMap">
		SELECT
		M.MEMBER_ID,
		M.EMAIL,
		M.MEMBER_NAME,
		M.PHONE,
		M.GENDER,
		M.MBTI,
		M.UPDATED_AT AS MEMBER_UPDATED_AT,
		M.CREATED_AT AS MEMBER_CREATED_AT,
		M.MEMBER_JOB,
		M.NICKNAME,
		M.ROLE,
		M.STATUS AS MEMBER_STATUS,

		U.TITLE AS UNIVERSE_TITLE,
		U.LAYOUT_DATA,
		U.THEME_CODE,
		U.STATUS AS UNIVERSE_STATUS,
		U.CREATED_AT AS UNIVERSE_CREATED_AT,
		U.UPDATED_AT AS UNIVERSE_UPDATED_AT,

		FS.SINGER_NO,
		FS.CREATED_AT AS FAV_SINGER_CREATED_AT,
		FS.UPDATED_AT AS FAV_SINGER_UPDATED_AT,
		TS.API_SINGER_NAME,
		TS.SINGER_GENRE,
		TS.SINGER_IMG_URL,

		FTS.TRACK_ORDER AS FAV_TRACK_ORDER,
		FTS.CREATE_AT AS FAV_SONG_CREATED_AT,
		FTS.UPDATE_AT AS FAV_SONG_UPDATED_AT,
		TAS.ALBUM AS FAV_ALBUM,
		TAS.DURATION AS FAV_DURATION,
		TAS.PREVIEW_URL AS FAV_PREVIEW_URL,
		TAS.RELEASE_DATE AS FAV_RELEASE_DATE,
		TAS.COVERIMG_URL AS FAV_COVERIMG_URL,
		TAS.TITLE AS FAV_TITLE,
		TAS.ARTIST_NAME AS FAV_ARTIST_NAME,
		TAS.GENRE_NAME AS FAV_GENRE_NAME,

		TG.GENRE_NAME,

		TP.PLAYLIST_NAME,
		TP.CREATED_AT AS PLAYLIST_CREATED_AT,
		TP.UPDATED_AT AS PLAYLIST_UPDATED_AT,

		TPSL.TRACK_ORDER,
		TPSL.CREATED_AT AS TRACK_CREATED_AT,
		TPSL.UPDATE_AT AS TRACK_UPDATED_AT,
		TPR.ALBUM AS TRACK_ALBUM,
		TPR.DURATION AS TRACK_DURATION,
		TPR.PREVIEW_URL AS TRACK_PREVIEW_URL,
		TPR.RELEASE_DATE AS TRACK_RELEASE_DATE,
		TPR.COVERIMG_URL AS TRACK_COVERIMG_URL,
		TPR.TITLE AS TRACK_TITLE,
		TPR.ARTIST_NAME AS TRACK_ARTIST_NAME,
		TPR.GENRE_NAME AS TRACK_GENRE_NAME

		FROM TB_MEMBER M
		LEFT JOIN TB_UNIVERSE U ON M.MEMBER_ID = U.MEMBER_ID
		LEFT JOIN TB_UNIVERSE_LIKED UK ON M.MEMBER_ID = UK.MEMBER_ID
		LEFT JOIN TB_FAV_UNIVERSE UF ON M.MEMBER_ID = UF.MEMBER_ID
		LEFT JOIN TB_FAV_SINGER FS ON M.MEMBER_ID = FS.MEMBER_ID
		LEFT JOIN TB_API_SINGER TS ON TS.SINGER_NO = FS.SINGER_NO
		LEFT JOIN TB_FAVORITE_SONG FTS ON M.MEMBER_ID = FTS.MEMBER_ID
		LEFT JOIN TB_API_SONG TAS ON FTS.SONG_NO = TAS.SONG_NO
		LEFT JOIN TB_MEMBER_GENRE MG ON M.MEMBER_ID = MG.MEMBER_ID
		LEFT JOIN TB_GENRE TG ON TG.GENRE_ID = MG.GENRE_ID
		LEFT JOIN TB_FAV_PLAYLIST TFP ON M.MEMBER_ID = TFP.MEMBER_ID
		LEFT JOIN TB_PLAYLIST TP ON M.MEMBER_ID = TP.MEMBER_ID
		LEFT JOIN TB_PLAYLIST_SONG_LIST TPSL ON TPSL.PLAYLIST_ID =
		TP.PLAYLIST_ID
		LEFT JOIN TB_PLAYLIST_TRACK TPR ON TPSL.SONG_ID = TPR.SONG_NO
		WHERE M.MEMBER_ID = #{memberId}
	</select>

	<!-- ResultMap 정의 -->
	<resultMap id="memberDetailMap"
		type="com.kh.replay.auth.admin.model.dto.MemberDetailDTO">

		<association property="member"
			javaType="com.kh.replay.member.model.dto.MemberDTO">
			<result property="memberId" column="MEMBER_ID" />
			<result property="email" column="EMAIL" />
			<result property="gender" column="GENDER" />
			<result property="mbti" column="MBTI" />
			<result property="updatedAt" column="MEMBER_UPDATED_AT" />
			<result property="createdAt" column="MEMBER_CREATED_AT" />
			<result property="name" column="MEMBER_NAME" />
			<result property="nickName" column="NICKNAME" />
			<result property="phone" column="PHONE" />
			<result property="job" column="MEMBER_JOB" />
			<result property="role" column="ROLE" />
			<result property="status" column="MEMBER_STATUS" />
		</association>

		<association property="shortform"
			javaType="com.kh.replay.shortform.model.dto.ShortformDTO">
		</association>

		<association property="playList"
			javaType="com.kh.replay.playList.model.dto.PlayListDTO">
			<result property="playListName" column="PLAYLIST_NAME" />
			<result property="createdAt" column="PLAYLIST_CREATED_AT" />
			<result property="updateAt" column="PLAYLIST_UPDATED_AT" />
			<result property="memberId" column="MEMBER_ID" />
		</association>

		<association property="artist"
			javaType="com.kh.replay.global.api.model.dto.ArtistDTO">
			<result property="apiSingerId" column="SINGER_NO" />
			<result property="apiSingerName" column="API_SINGER_NAME" />
			<result property="singerGenre" column="SINGER_GENRE" />
			<result property="singerImgUrl" column="SINGER_IMG_URL" />
		</association>

		<association property="music"
			javaType="com.kh.replay.global.api.model.dto.MusicDTO">
			<result property="title" column="FAV_TITLE" />
			<result property="artistName" column="FAV_ARTIST_NAME" />
			<result property="album" column="FAV_ALBUM" />
			<result property="genreName" column="FAV_GENRE_NAME" />
			<result property="coverImgUrl" column="FAV_COVERIMG_URL" />
			<result property="previewUrl" column="FAV_PREVIEW_URL" />
			<result property="releaseDate" column="FAV_RELEASE_DATE" />
			<result property="duration" column="FAV_DURATION" />
		</association>

	</resultMap>

	<!-- 신고 목록 조회 -->
	<select id="findReportList"
		parameterType="com.kh.replay.auth.admin.model.dto.PageRequestDTO"
		resultType="com.kh.replay.auth.admin.model.dto.ReportCommentDTO"> SELECT
		REPORT_ID AS reportNo, REASON_CODE AS reasonCode, DESCRIPTION AS
		description, STATUS AS status, CREATED_AT AS createdAt, MEMBER_ID AS
		memberId FROM TB_COMMENT_REPORT WHERE REPORT_ID IS NOT NULL AND STATUS =
		'Y' <if test="keyword != null">
			AND (DESCRIPTION LIKE #{keyword}
			OR REASON_CODE LIKE #{keyword})
		</if>
		ORDER BY CREATED_AT DESC OFFSET #{offset} ROWS FETCH NEXT #{limit} ROWS
		ONLY </select>

	<!-- 신고 상세 조회 -->
	<select id="getReportDetails"
		parameterType="long"
		resultMap="reportDetailMap">
		SELECT
		REPORT_TYPE,
		REPORT_ID,
		REASON_CODE,
		DESCRIPTION,
		STATUS,
		CREATED_AT,
		MEMBER_ID,
		TARGET_ID
		FROM (
		SELECT
		'SHORT_FORM' AS REPORT_TYPE,
		REPORT_ID,
		REASON_CODE,
		DESCRIPTION,
		STATUS,
		CREATED_AT,
		MEMBER_ID,
		SHORTS_ID AS TARGET_ID
		FROM TB_SHORT_FORM_REPORT
		WHERE REPORT_ID = #{reportNo}

		UNION ALL

		SELECT
		'COMMENT' AS REPORT_TYPE,
		REPORT_ID,
		REASON_CODE,
		DESCRIPTION,
		STATUS,
		CREATED_AT,
		MEMBER_ID,
		COMMENT_ID AS TARGET_ID
		FROM TB_COMMENT_REPORT
		WHERE REPORT_ID = #{reportNo}

		UNION ALL

		SELECT
		'UNIVERSE' AS REPORT_TYPE,
		REPORT_ID,
		REASON_CODE,
		DESCRIPTION,
		STATUS,
		CREATED_AT,
		MEMBER_ID,
		UNIVERSE_ID AS TARGET_ID
		FROM TB_UNIVERSE_REPORT
		WHERE REPORT_ID = #{reportNo}
		)
	</select>

	<!-- ResultMap: 신고 상세 -->
	<resultMap id="reportDetailMap"
		type="com.kh.replay.auth.admin.model.dto.ReportDetailDTO">
		<result property="reportType" column="REPORT_TYPE" />
		<result property="reportNo" column="REPORT_ID" />
		<result property="reasonCode" column="REASON_CODE" />
		<result property="description" column="DESCRIPTION" />
		<result property="status" column="STATUS" />
		<result property="createdAt" column="CREATED_AT" />
		<result property="memberId" column="MEMBER_ID" />
		<result property="targetId" column="TARGET_ID" />
	</resultMap>

	<!-- 신고 존재 여부 확인 -->
	<select id="countByReport"
		parameterType="long"
		resultType="int">
		SELECT COUNT(*)
		FROM (
		SELECT REPORT_ID FROM TB_UNIVERSE_REPORT WHERE REPORT_ID = #{reportNo}
		UNION ALL
		SELECT REPORT_ID FROM TB_SHORT_FORM_REPORT WHERE REPORT_ID = #{reportNo}
		UNION ALL
		SELECT REPORT_ID FROM TB_COMMENT_REPORT WHERE REPORT_ID = #{reportNo}
		)
	</select>

	<!-- 신고 상태 업데이트 -->
	<update id="updateShortFormReportStatus" parameterType="long">
		UPDATE TB_SHORT_FORM_REPORT
		SET STATUS = 'N'
		WHERE REPORT_ID = #{reportNo}
	</update>

	<update id="updateCommentReportStatus" parameterType="long">
		UPDATE TB_COMMENT_REPORT
		SET STATUS = 'N'
		WHERE REPORT_ID = #{reportNo}
	</update>

	<update id="updateUniverseReportStatus" parameterType="long">
		UPDATE TB_UNIVERSE_REPORT
		SET STATUS = 'N'
		WHERE REPORT_ID = #{reportNo}
	</update>

</mapper>