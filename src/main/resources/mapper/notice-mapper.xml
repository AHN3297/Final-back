<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kh.replay.notice.model.repository.NoticeRepository">

	<resultMap id="noticeResultSet" type="com.kh.replay.notice.model.domain.Notice">
		<id property="noticeNo" column="NOTICE_NO" />
		<result property="noticeTitle" column="NOTICE_TITLE" />
		<result property="noticeContent" column="NOTICE_CONTENT" />
		<result property="memberId" column="MEMBER_ID" />
		<result property="status" column="STATUS" />
		<result property="createdAt" column="CREATED_AT" />
		<result property="updatedAt" column="UPDATED_AT" />
	</resultMap>

	<!-- 공지사항 목록 조회 -->
	<!-- 상태값(status) 기준 필터링 및 제목 키워드 검색 지원 -->
	<!-- 최신 공지사항이 먼저 노출되도록 내림차순 정렬 -->
	<!-- OFFSET / FETCH NEXT 를 이용한 페이징 처리 -->
	<select id="findAll" resultMap="noticeResultSet">
		SELECT
		       *
		  FROM
		       (     
				SELECT
					   NOTICE_NO
					 , NOTICE_TITLE
					 , NOTICE_CONTENT
					 , MEMBER_ID
					 , STATUS
					 , CREATED_AT
					 , UPDATED_AT
			      FROM
			     	   TB_NOTICE
			     WHERE
			           STATUS = #{status}
				<if test="keyword != null and keyword != ''">
					AND
					    NOTICE_TITLE LIKE '%' || #{keyword} || '%'
				</if>
				  ORDER BY NOTICE_NO DESC
				)
		OFFSET #{offset} ROWS FETCH NEXT #{limit} ROWS ONLY		
	</select>

	<!-- 공지사항 목록 페이징을 위한 전체 데이터 개수 조회 -->
	<!-- 상태값 및 키워드 조건을 목록 조회와 동일하게 적용 -->
	<select id="countAll" resultType="_int">
		SELECT
		       COUNT(*)
		  FROM
		       TB_NOTICE
		 WHERE
		       STATUS = #{status}
		<if test="keyword != null and keyword != ''">
			AND
			    NOTICE_TITLE LIKE '%' || #{keyword} || '%'
		</if>
	</select>

	<!-- 공지사항 신규 등록 -->
	<!-- 시퀀스를 이용해 공지사항 번호를 미리 생성 -->
	<!-- 기본 상태값은 'Y', 생성/수정 시간은 SYSDATE로 처리 -->
	<insert id="save" parameterType="com.kh.replay.notice.model.domain.Notice">
		<selectKey keyProperty="noticeNo" resultType="long" order="BEFORE">
			SELECT SEQ_NOTICE_NO.NEXTVAL FROM DUAL
		</selectKey>
	
		INSERT INTO TB_NOTICE
		       (
		       NOTICE_NO
		     , NOTICE_TITLE
		     , NOTICE_CONTENT
		     , MEMBER_ID
		     , STATUS
		     , CREATED_AT
		     , UPDATED_AT
		       )
	    VALUES 
	    	   (
	    	   #{noticeNo}
	    	 , #{noticeTitle}
	    	 , #{noticeContent}
	    	 , #{memberId}
	    	 , 'Y'
	    	 , SYSDATE
	    	 , SYSDATE  
	    	   )
	</insert>
	
	<!-- 공지사항에 첨부된 이미지 정보 저장 -->
	<!-- 이미지 파일명(origin/change)과 공지사항 번호를 매핑 -->
	<insert id="saveImg" parameterType="com.kh.replay.notice.model.domain.NoticeImg">
		INSERT 
		  INTO 
		        TB_NOTICE_IMG
				(
				IMG_ID
			  , ORIGIN_NAME
			  , CHANGE_NAME
			  , STATUS
			  , NOTICE_NO
				)
		VALUES
				(
				SEQ_IMG_ID.NEXTVAL
			  , #{originName}
			  , #{changeName}
			  , 'Y'
			  , #{noticeNo}
				)
	</insert>
	
	<!-- 공지사항 상세 조회 -->
	<!-- 공지사항 번호 기준 단건 조회 -->
	<select id="findById" resultMap="noticeResultSet">
		SELECT
		       NOTICE_NO
			 , NOTICE_TITLE
			 , NOTICE_CONTENT
			 , MEMBER_ID
			 , STATUS
			 , CREATED_AT
			 , UPDATED_AT
	      FROM
	           TB_NOTICE
	     WHERE
	           NOTICE_NO = #{id}
	</select>
	
	<!-- 공지사항 수정 화면에서 사용할 단건 조회 -->
	<!-- 컬럼을 도메인 필드명으로 alias 처리 -->
	<select id="findByNoticeNo"
			resultType="com.kh.replay.notice.model.domain.Notice">
		SELECT
			   NOTICE_NO AS noticeNo
			 , NOTICE_TITLE AS noticeTitle
			 , NOTICE_CONTENT AS noticeContent
			 , MEMBER_ID AS memberId
			 , STATUS AS status
		  FROM
		       TB_NOTICE
		 WHERE
		       NOTICE_NO = #{noticeNo}
	</select>
	
	<!-- 특정 공지사항에 등록된 이미지 목록 조회 -->
	<!-- 사용중인 이미지(STATUS = 'Y')만 조회 -->
	<!-- 이미지 순서를 보장하기 위해 IMG_ID 기준 정렬 -->
	<select id="findImageUrlsByNoticeNo"
			resultType="string">
		SELECT
		       CHANGE_NAME
		  FROM
		       TB_NOTICE_IMG
		 WHERE
		       NOTICE_NO = #{noticeNo}
		   AND
		       STATUS = 'Y'
		 ORDER
		    BY
		       IMG_ID ASC 		
	</select>
	
	<!-- 공지사항 제목 및 내용 수정 -->
	<!-- 수정 시 UPDATED_AT 갱신 -->
	<update id="updateNotice">
		UPDATE
		       TB_NOTICE
		   SET
		       NOTICE_TITLE = #{req.noticeTitle}
		     , NOTICE_CONTENT = #{req.noticeContent}
		     , UPDATED_AT = SYSDATE
		 WHERE
		       NOTICE_NO = #{noticeNo}
	</update>
	
	<!-- 선택된 공지사항 이미지 논리 삭제 -->
	<!-- IMG_ID 목록을 받아 STATUS 값을 'N'으로 변경 -->
	<update id="deleteNoticeImages">
		UPDATE
		       TB_NOTICE_IMG
		   SET
		       STATUS = 'N'
		 WHERE
		       IMG_ID IN
		<foreach collection="list" item="id" open="(" close=")" separator=",">
			#{id}
		</foreach>
	</update>
	
	<!-- 공지사항 수정 시 신규 이미지 추가 -->
	<!-- 기존 이미지 삭제 후 새로운 이미지 삽입 용도 -->
	<insert id="insertNoticeImage">
		INSERT
		  INTO
		       TB_NOTICE_IMG
		       (
		       IMG_ID
		     , ORIGIN_NAME
		     , CHANGE_NAME
		     , STATUS
		     , NOTICE_NO
		       )
	    VALUES
	   		   (
	   		   SEQ_IMG_ID.NEXTVAL
	   		 , #{originName}
	   		 , #{changeName}
	   		 , 'Y'
	   		 , #{noticeNo}
	   		   )
	</insert>
	
	<!-- 공지사항에 연결된 이미지 ID 목록 조회 -->
	<!-- 이미지 삭제 처리를 위한 사전 조회 -->
	<select id="findImgIdsByNoticeNo">
		SELECT
		       IMG_ID
		  FROM
		       TB_NOTICE_IMG
		 WHERE
		       NOTICE_NO = #{noticeNo}
		   AND
		       STATUS = 'Y'     
	</select>
	
	<!-- 공지사항 논리 삭제 -->
	<!-- 실제 데이터 삭제가 아닌 STATUS 값 변경 -->
	<update id="deleteNotice">
		UPDATE
		       TB_NOTICE
		   SET
		       STATUS = 'N'
		    ,  UPDATED_AT = SYSDATE
		WHERE
		       NOTICE_NO = #{noticeNo}    
	</update>
	
</mapper>