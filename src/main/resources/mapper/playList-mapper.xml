<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kh.replay.playList.model.dao.PlayListMapper">
	
	<insert id="createPlayList">
	    <selectKey keyProperty="playListId" resultType="int" order="BEFORE">
	        SELECT SEQ_PLAYLIST_ID.NEXTVAL FROM DUAL
	    </selectKey>
	
	    INSERT 
	      INTO 
	           TB_PLAYLIST (
	           PLAYLIST_ID, 
	           PLAYLIST_NAME, 
	           MEMBER_ID, 
	           CREATED_AT, 
	           UPDATED_AT
	           ) 
	    VALUES (
	           #{playListId}, 
	           #{playListName}, 
	           #{memberId}, 
	           SYSDATE, 
	           SYSDATE
	           )
	</insert>
	
	<select id="findAllMemberPlayLists" resultType="com.kh.replay.playList.model.dto.PlayListDTO">
	    SELECT 
	           PLAYLIST_ID as playListId,
	           PLAYLIST_NAME as playListName,
	           MEMBER_ID as memberId,
	           CREATED_AT as createdAt, -- TO_CHAR 제거
	           UPDATED_AT as updatedAt  -- TO_CHAR 제거
	      FROM 
	           TB_PLAYLIST
	     WHERE 
	           MEMBER_ID = #{memberId}
	     ORDER 
	        BY 
	           CREATED_AT DESC
	</select>
	
	<delete id="deleteMainPlayList">
		DELETE 
		  FROM 
		       TB_MAIN_PLAYLIST 
    	 WHERE 
    	       MEMBER_ID = #{memberId}
	</delete>
	
	<insert id="createMainPlayList">
		INSERT 
		  INTO 
		       TB_MAIN_PLAYLIST (
		       MEMBER_ID,
		       PLAYLIST_ID
		       )
	    VALUES (
	           #{memberId},
	           #{playListId}
		       )
	</insert>
	
	<update id="updatePlayListName">  
	    UPDATE 
	    	   TB_PLAYLIST
	       SET 
	           PLAYLIST_NAME = #{playListName}
	     WHERE 
	           PLAYLIST_ID = #{playListId}
	       AND 
	           MEMBER_ID = #{memberId}  
	</update>
	
	<delete id="deletePlayList">
	    DELETE 
	      FROM 
	           TB_PLAYLIST
	     WHERE 
	           PLAYLIST_ID = #{playListId}
	       AND 
	           MEMBER_ID = #{memberId}
	</delete>
	
	<insert id="createTrack" useGeneratedKeys="true" keyProperty="trackId" keyColumn="SONG_NO">
	    INSERT 
	      INTO 
	           TB_PLAYLIST_TRACK 
	           (
	            SONG_NO
	          , ARTIST_ID
	          , TRACK_ID
	          , ALBUM
	          , DURATION
	          , PREVIEW_URL
	          , RELEASE_DATE
	          , COVERIMG_URL
	          , TITLE
	          , ARTIST_NAME
	          , GENRE_NAME
	            ) 
	    VALUES (
	            SEQ_SONG_NO.NEXTVAL
	          , #{artistId}
	          , #{trackId}
	          , #{album}
	          , #{duration}
	          , #{previewUrl}
	          , #{releaseDate}
	          , #{coverImgUrl}
	          , #{title}
	          , #{artistName}
	          , #{genreName}
	            )
	</insert>
	
	<insert id="insertPlaylistSong">
	    INSERT 
	      INTO 
	           TB_PLAYLIST_SONG_LIST 
	           (
	           PLAYLIST_SONG_NO
	         , PLAYLIST_ID
	         , SONG_ID
	         , TRACK_ORDER
	           ) 
	   VALUES (
	           SEQ_PL_SONG_NO.NEXTVAL
	         , #{playListId}
	         , #{songNo}
	         , #{trackOrder}
	           )
	</insert>
	
	<select id="getNextTrackOrder" resultType="_int">
	    SELECT 
	           NVL(MAX(TRACK_ORDER), 0) + 1
	      FROM 
	           TB_PLAYLIST_SONG_LIST
	     WHERE 
	           PLAYLIST_ID = #{playListId}
	</select>
	
</mapper>